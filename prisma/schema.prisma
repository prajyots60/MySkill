generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id                   String                @id @default(cuid())
  name                 String?
  email                String?               @unique
  emailVerified        DateTime?
  image                String?
  role                 UserRole              @default(STUDENT)
  bio                  String?
  youtubeConnected     Boolean               @default(false)
  socialLinks          Json?
  onboarded            Boolean               @default(false)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  youtubeChannelId     String?
  youtubeChannelName   String?
  youtubeConnectedAt   DateTime?
  youtubeThumbnailUrl  String?
  gdriveConnected      Boolean               @default(false)
  gdriveConnectedAt    DateTime?
  gdriveEmail          String?
  gdriveName           String?
  gdriveProfileImage   String?
  dailymotionConnected Boolean               @default(false)
  accounts             Account[]
  bookmarks            Bookmark[]
  comments             Comment[]
  contents             Content[]
  creatorProfile       CreatorProfile?
  dailymotionInfo      DailymotionInfo?
  documents            Document[]
  enrollments          Enrollment[]
  eventReminders       EventReminder[]
  createdExams         Exam[]
  progress             Progress[]
  reviews              Review[]
  sessions             Session[]
  studentExamResponses StudentExamResponse[]
  followers            UserFollow[]          @relation("UserFollowers")
  following            UserFollow[]          @relation("UserFollowing")
  userServiceConnections UserServiceConnection[]

  @@index([email])
}

model CreatorProfile {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  customTitle            String?
  tagline                String?
  themeColor             String?  @default("default")
  location               String?
  languages              String[]
  expertise              String[]
  yearsTeaching          String?
  education              String?
  achievements           String?
  institutionName        String?
  institutionDescription String?
  institutionWebsite     String?
  verified               Boolean  @default(false)
  badges                 Json?
  milestones             Json?
  testimonials           Json?
  customSections         Json?
  resources              Json?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  categories             String[]
  resourcesDescription   String?
  showResources          Boolean  @default(false)
  socialLinks            Json?
  website                String?
  coverImages            String[]
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserFollow {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  followerId  String
  followingId String
  follower    User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Content {
  id             String        @id @default(cuid())
  title          String
  description    String
  thumbnail      String?
  type           ContentType   @default(COURSE)
  price          Float?        @default(0)
  isPublished    Boolean       @default(false)
  tags           String[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  creatorId      String
  accessDuration Int?
  courseStatus   CourseStatus? @default(UPCOMING)
  deliveryMode   DeliveryMode? @default(VIDEO)
  languages      String[]
  richContent    Json?
  bookmarks      Bookmark[]
  comments       Comment[]
  creator        User          @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  documents      Document[]
  enrollments    Enrollment[]
  exams          Exam[]
  resources      Resource[]
  reviews        Review[]
  sections       Section[]

  @@index([creatorId])
  @@index([type])
  @@index([isPublished])
}

model Section {
  id          String     @id @default(cuid())
  title       String
  description String?
  order       Int
  contentId   String
  documents   Document[]
  exams       Exam[]
  lectures    Lecture[]
  resources   Resource[]
  content     Content    @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId])
}

model Lecture {
  id             String          @id @default(cuid())
  title          String
  description    String?
  order          Int
  type           LectureType     @default(VIDEO)
  videoId        String?
  duration       Int?
  isPreview      Boolean         @default(false)
  liveStatus     LiveStatus?
  scheduledAt    DateTime?
  startedAt      DateTime?
  endedAt        DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  sectionId      String
  streamData     Json?
  comments       Comment[]
  documents      Document[]
  eventReminders EventReminder[]
  exams          Exam[]
  section        Section         @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  progress       Progress[]
  resources      Resource[]

  @@index([sectionId])
  @@index([type])
  @@index([isPreview])
}

model Enrollment {
  id         String   @id @default(cuid())
  enrolledAt DateTime @default(now())
  userId     String
  contentId  String
  content    Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, contentId])
  @@index([userId])
  @@index([contentId])
}

model Progress {
  id               String   @id @default(cuid())
  percentage       Int      @default(0)
  isComplete       Boolean  @default(false)
  updatedAt        DateTime @updatedAt
  userId           String
  lectureId        String
  timeSpentSeconds Int      @default(0)
  createdAt        DateTime @default(now())
  lecture          Lecture  @relation(fields: [lectureId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lectureId])
  @@index([userId])
  @@index([lectureId])
}

model Comment {
  id        String    @id @default(cuid())
  text      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  userId    String
  contentId String?
  lectureId String?
  parentId  String?
  content   Content?  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  lecture   Lecture?  @relation(fields: [lectureId], references: [id], onDelete: Cascade)
  parent    Comment?  @relation("CommentToComment", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentToComment")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([contentId])
  @@index([lectureId])
  @@index([parentId])
}

model Document {
  id          String   @id @default(cuid())
  title       String
  description String?
  url         String
  type        String
  size        Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  contentId   String?
  sectionId   String?
  lectureId   String?
  creatorId   String
  content     Content? @relation(fields: [contentId], references: [id], onDelete: Cascade)
  creator     User     @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  lecture     Lecture? @relation(fields: [lectureId], references: [id], onDelete: Cascade)
  section     Section? @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@index([sectionId])
  @@index([lectureId])
  @@index([creatorId])
}

model Bookmark {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  contentId String
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, contentId])
  @@index([userId])
  @@index([contentId])
}

model Resource {
  id        String   @id @default(cuid())
  fileId    String
  fileName  String
  fileType  String
  fileSize  Int
  fileUrl   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  courseId  String
  sectionId String?
  lectureId String?
  course    Content  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lecture   Lecture? @relation(fields: [lectureId], references: [id], onDelete: Cascade)
  section   Section? @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([sectionId])
  @@index([lectureId])
}

model EventReminder {
  id           String    @id @default(cuid())
  createdAt    DateTime  @default(now())
  userId       String
  lectureId    String
  reminderSent Boolean   @default(false)
  sentAt       DateTime?
  lecture      Lecture   @relation(fields: [lectureId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lectureId])
  @@index([userId])
  @@index([lectureId])
  @@index([reminderSent])
}

model Exam {
  id                 String                @id @default(cuid())
  title              String
  description        String?
  instructions       String?
  type               ExamType              @default(QUIZ)
  status             ExamStatus            @default(DRAFT)
  passingScore       Int?
  timeLimit          Int?
  startDate          DateTime?
  endDate            DateTime?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  contentId          String?
  sectionId          String?
  lectureId          String?
  creatorId          String
  formId             String?               @unique
  allowReview        Boolean               @default(true)
  randomizeQuestions Boolean               @default(false)
  content            Content?              @relation(fields: [contentId], references: [id])
  creator            User                  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  lecture            Lecture?              @relation(fields: [lectureId], references: [id])
  section            Section?              @relation(fields: [sectionId], references: [id])
  questions          Question[]
  studentResponses   StudentExamResponse[]

  @@index([creatorId])
  @@index([contentId])
  @@index([sectionId])
  @@index([lectureId])
  @@index([status])
}

model Question {
  id              String             @id @default(cuid())
  text            String
  type            QuestionType
  required        Boolean            @default(true)
  order           Int
  points          Int                @default(1)
  negativeMarking Float?
  examId          String
  questionId      String
  exam            Exam               @relation(fields: [examId], references: [id], onDelete: Cascade)
  options         QuestionOption[]
  responses       QuestionResponse[]

  @@index([examId])
}

model QuestionOption {
  id         String   @id @default(cuid())
  text       String
  isCorrect  Boolean  @default(false)
  order      Int
  questionId String
  optionId   String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model StudentExamResponse {
  id         String             @id @default(cuid())
  startTime  DateTime           @default(now())
  submitTime DateTime?
  score      Int?
  maxScore   Int?
  passed     Boolean?
  examId     String
  studentId  String
  responseId String?
  responses  QuestionResponse[]
  exam       Exam               @relation(fields: [examId], references: [id], onDelete: Cascade)
  student    User               @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([examId, studentId])
  @@index([examId])
  @@index([studentId])
}

model QuestionResponse {
  id                    String              @id @default(cuid())
  studentExamResponseId String
  questionId            String
  selectedOptionIds     String[]
  textResponse          String?
  isCorrect             Boolean?
  pointsAwarded         Float?
  question              Question            @relation(fields: [questionId], references: [id], onDelete: Cascade)
  studentExamResponse   StudentExamResponse @relation(fields: [studentExamResponseId], references: [id], onDelete: Cascade)

  @@index([studentExamResponseId])
  @@index([questionId])
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  contentId String
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, contentId])
  @@index([userId])
  @@index([contentId])
  @@index([rating])
}

model DailymotionInfo {
  id                String   @id @default(cuid())
  userId            String   @unique
  dailymotionUserId String
  username          String?
  screenname        String?
  accessToken       String
  refreshToken      String?
  expiresAt         DateTime
  profilePictureUrl String?
  scope             String?
  connectedAt       DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentials       DailymotionCredentials?

  @@index([userId])
}

model DailymotionCredentials {
  id                String   @id @default(cuid())
  dailymotionInfoId String   @unique
  apiKey            String   // Encrypted API key
  apiSecret         String   // Encrypted API secret
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  dailymotionInfo   DailymotionInfo @relation(fields: [dailymotionInfoId], references: [id], onDelete: Cascade)

  @@index([dailymotionInfoId])
}

model UserServiceConnection {
  id            String   @id @default(cuid())
  userId        String
  service       String   // e.g., 'DAILYMOTION', 'YOUTUBE', etc.
  isConnected   Boolean  @default(false)
  lastConnected DateTime
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, service])
  @@index([userId])
  @@index([service])
}

enum UserRole {
  STUDENT
  CREATOR
  ADMIN
}

enum ContentType {
  COURSE
  EVENT
  SHOW
  PODCAST
  PERFORMANCE
}

enum CourseStatus {
  UPCOMING
  ONGOING
  COMPLETED
}

enum DeliveryMode {
  VIDEO
  LIVE
  HYBRID
}

enum LectureType {
  VIDEO
  LIVE
  DOCUMENT
}

enum LiveStatus {
  SCHEDULED
  LIVE
  ENDED
}

enum ExamType {
  QUIZ
  MCQ
  ASSIGNMENT
  FINAL
}

enum ExamStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum QuestionType {
  MULTIPLE_CHOICE
  CHECKBOX
  SHORT_ANSWER
  PARAGRAPH
}
